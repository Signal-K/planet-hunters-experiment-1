version: '3.8'

services:
  # Main React Native development service
  react-native:
    build:
      context: .
      dockerfile: Dockerfile
      cache_from:
        - react-native:latest
    container_name: godot-react-native-dev
    ports:
      - "8081:8081"    # Metro bundler
      - "8082:8082"    # Dev server
      - "19000:19000"  # Expo dev client
    volumes:
      # Source code volumes for hot reload
      - ./app:./app
      - ./components:./components
      - ./scripts:./scripts
      - ./project:./project
      - ./docs:./docs
      - ./.xcode.env:./.xcode.env
      - ./index.js:./index.js
      - ./App.tsx:./App.tsx
      - ./babel.config.js:./babel.config.js
      - ./metro.config.js:./metro.config.js
      - ./tsconfig.json:./tsconfig.json
      
      # Node modules volume to prevent reinstalling on each run
      - node_modules:/app/node_modules
      
      # Cache volumes for faster rebuilds
      - metro_cache:/.metro
      - gradle_cache:/.gradle
      - npm_cache:/.npm
      - yarn_cache:/.yarn
    environment:
      NODE_ENV: development
      NODE_BINARY: /usr/local/bin/node
      REACT_NATIVE_PACKAGER_HOSTNAME: localhost
      METRO_PORT: 8081
      RCT_METRO_PORT: 8081
    working_dir: /app
    command: npm start
    networks:
      - godot-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Optional: Godot editor service (for headless Godot operations)
  godot-cli:
    build:
      context: .
      dockerfile: Dockerfile.godot
    container_name: godot-cli
    volumes:
      - ./project:/app/project
      - ./ios:/app/ios
      - ./android:/app/android
      - godot_cache:/.godot
    working_dir: /app/project
    environment:
      GODOT_PATH: /opt/godot
    profiles:
      - godot  # Only start with --profile godot flag
    networks:
      - godot-network
    restart: unless-stopped

  # Optional: iOS build service (requires macOS host)
  ios-builder:
    build:
      context: .
      dockerfile: Dockerfile.ios
    container_name: ios-builder
    volumes:
      - ./ios:/app/ios
      - ./node_modules:/app/node_modules
      - ./project:/app/project
      - ios_build_cache:/app/ios/build
      - xcode_cache:/.Xcode
    working_dir: /app
    environment:
      NODE_BINARY: /usr/local/bin/node
      XCODE_PATH: /Applications/Xcode.app
    profiles:
      - ios  # Only start with --profile ios flag
    networks:
      - godot-network
    restart: unless-stopped
    # Note: This requires macOS host

  # Optional: Android build service
  android-builder:
    build:
      context: .
      dockerfile: Dockerfile.android
    container_name: android-builder
    volumes:
      - ./android:/app/android
      - ./node_modules:/app/node_modules
      - ./project:/app/project
      - android_build_cache:/app/android/build
      - gradle_cache:/.gradle
      - android_sdk:/.android
    working_dir: /app
    environment:
      NODE_BINARY: /usr/local/bin/node
      ANDROID_SDK_ROOT: /opt/android-sdk
      ANDROID_HOME: /opt/android-sdk
      GRADLE_USER_HOME: /.gradle
    profiles:
      - android  # Only start with --profile android flag
    networks:
      - godot-network
    restart: unless-stopped

volumes:
  node_modules:
    driver: local
  metro_cache:
    driver: local
  gradle_cache:
    driver: local
  npm_cache:
    driver: local
  yarn_cache:
    driver: local
  godot_cache:
    driver: local
  ios_build_cache:
    driver: local
  xcode_cache:
    driver: local
  android_build_cache:
    driver: local
  android_sdk:
    driver: local

networks:
  godot-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
